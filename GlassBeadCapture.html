<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>19x19 Bead Capture Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            display: grid;
            grid-template-columns: 1fr 800px 1fr;
            height: 100vh;
            margin: 0;
            padding: 0;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            background-image: url('background.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            overflow-y: scroll;
            overflow-x: hidden;
            align-items: center;
               column-gap: 60px;
        }
        #mainContent {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 800px;
            min-width: 800px;
            flex-shrink: 0;
            grid-column: 2;
        }
        #buttonColumn {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0px;
            align-items: center;
            justify-items: center;
            width: auto;
            margin: 0;
            padding: 0;
            flex-shrink: 0;
            grid-column: 3;
        }
        #playButtonContainer {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0px;
            align-items: center;
            justify-items: center;
            width: auto;
            margin: 0;
        }
        .button-with-info {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        .info-icon {
            position: absolute;
            left: calc(50% + 130px);
            width: 40px;
            height: 40px;
            background-image: url('questionmark2.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: transparent;
            border: none;
            border-radius: 0;
            color: transparent;
            font-size: 0;
            font-weight: bold;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, background-color 0.2s ease, border-color 0.2s ease;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
        }
        .info-icon:hover {
            transform: scale(1.1);
            background-color: transparent;
        }
        #infoModal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
        }
        #infoModalContent {
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.99), rgba(40, 30, 50, 0.99));
            border: 3px solid #d4a373;
            border-radius: 25px;
            padding: 50px 60px;
            max-width: 650px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.8), 0 0 80px rgba(212, 163, 115, 0.2);
            position: relative;
        }
        #infoModalContent h2 {
            color: #FFD700;
            font-size: 40px;
            margin: 0 0 25px 0;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            text-align: center;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        #infoModalContent p {
            color: #d4a373;
            font-size: 19px;
            line-height: 1.7;
            margin: 16px 0;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            font-weight: 500;
        }
        #infoModalContent strong {
            color: #FFD700;
            font-weight: 700;
        }
        #infoModalContent ul {
            color: #d4a373;
            font-size: 19px;
            line-height: 2;
            margin: 20px 0;
            padding-left: 30px;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            font-weight: 500;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            color: white;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .close-modal:hover {
            color: #d4a373;
        }
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-in-out;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        #mainButtonRow {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0px;
            align-items: center;
            justify-items: center;
            width: auto;
            margin: 0;
        }
        #quitButtonRow {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0px;
            align-items: center;
            justify-items: center;
            width: auto;
            margin: 0;
        }
        svg {
            border: 3px solid rgba(212, 163, 115, 0.8);
            border-radius: 8px;
            width: 800px;
            height: 800px;
            min-width: 800px;
            min-height: 800px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            background-color: rgba(255, 255, 255, 0.02);
            display: block;
            margin: 0;
            padding: 0;
            flex-shrink: 0;
        }
        .scoreboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            align-items: start;
            justify-items: stretch;
            font-size: 16px;
            font-weight: bold;
            display: none;
            color: #d4a373;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            padding: 0;
            margin: 0;
            border-radius: 0;
            background: transparent;
            border: none;
            box-shadow: none;
            width: 100%;
        }
        .scoreboard > p:first-child {
            grid-column: 1 / -1;
            margin: 0 0 15px 0;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            color: #FFD700;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            letter-spacing: 0.5px;
        }
        .score-item {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 12px;
            align-items: center;
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.08);
            border-left: 3px solid rgba(212, 163, 115, 0.6);
            border-radius: 6px;
        }
        .score-item p {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            white-space: nowrap;
        }
        .score-item .captured-stones {
            width: 100%;
            justify-content: flex-start;
        }
        .button-group {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            justify-content: center;
            align-items: center;
            width: fit-content;
            margin-top: 15px;
            padding: 12px 20px;
            border: 2px solid rgba(212, 163, 115, 0.5);
            border-radius: 12px;
            background: rgba(20, 20, 40, 0.7);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }
        #turnDisplay {
            position: static;
            font-size: 28px;
            font-weight: 700;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            color: #FFD700;
            margin: 0;
            padding: 8px 16px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
            letter-spacing: 0.5px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        #winMessage {
            font-size: 30px;
            color: #FFD700;
            font-weight: bold;
            display: none;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
        }
        #gameScreen {
            display: block;
            position: relative;
        }
        #winScreen, #tournamentEndScreen {
            display: none;
            text-align: center;
            transition: opacity 0.5s ease-in-out;
        }
        #winScreen {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            width: auto;
            opacity: 0;
        }
        #tournamentEndScreen {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.99), rgba(40, 30, 50, 0.99));
            border: 3px solid #d4a373;
            border-radius: 25px;
            padding: 60px 100px;
            text-align: center;
            max-width: 900px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.8), 0 0 80px rgba(212, 163, 115, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #winOverlay {
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.97), rgba(30, 25, 45, 0.97));
            border: 3px solid #d4a373;
            border-radius: 25px;
            padding: 30px 50px;
            text-align: center;
            max-width: 1000px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.7), 0 0 60px rgba(212, 163, 115, 0.3);
        }
        #winScreenMessage {
            font-size: 72px;
            font-weight: bold;
            color: #FFD700;
            margin: 0 0 5px 0;
            text-shadow: 0 6px 15px rgba(0, 0, 0, 0.8), 0 2px 4px rgba(255, 215, 0, 0.3);
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            letter-spacing: 1px;
        }
        #winDetails {
            font-size: 36px;
            color: #d4a373;
            margin: 0 0 20px 0;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        #scoreDisplay {
            color: #FFD700;
            font-size: 18px;
            margin: 12px 0;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
        }
        #capturesGrid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-top: 20px;
            width: 100%;
        }
        .playerCaptureBox {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.08));
            border: 2px solid rgba(212, 163, 115, 0.7);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .playerCaptureBox p {
            font-weight: 700;
            text-transform: uppercase;
            margin: 0 0 8px 0;
            letter-spacing: 0.5px;
            font-size: 18px;
        }
        .captureBeads {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            justify-items: center;
            margin-top: 8px;
        }
        .capturePair {
            display: flex;
            gap: 3px;
            align-items: center;
            justify-content: center;
            padding: 5px;
            border-radius: 8px;
        }
        #winButtonsContainer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            margin-top: 20px;
            justify-items: center;
        }
        #rematchButton, #quitGameButton {
            width: 160px;
            height: 80px;
            padding: 0;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: transparent;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        #rematchButton:hover, #quitGameButton:hover {
            transform: scale(1.1);
        }
        .name-entry {
            text-align: center;
            font-size: 20px;
            margin-bottom: 16px;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            color: #d4a373;
            display: none;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        input[type="text"] {
            padding: 12px 16px;
            font-size: 18px;
            margin: 8px;
            color: #FFD700;
            background-color: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(212, 163, 115, 0.6);
            border-radius: 8px;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            transition: all 0.3s ease;
            text-align: center;
        }
        input[type="text"]:focus {
            background-color: rgba(255, 255, 255, 0.25);
            border-color: #d4a373;
            outline: none;
            box-shadow: 0 0 15px rgba(212, 163, 115, 0.4);
        }
        input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        button {
            padding: 0;
            font-size: 22px;
            cursor: pointer;
            background-color: transparent;
            color: white;
            border: none;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            transition: transform 0.2s ease, filter 0.2s ease;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            z-index: 1;
            margin: 0;
            width: 160px;
            height: 80px;
        }
        button:hover {
            transform: scale(1.08);
            background-color: transparent;
            filter: brightness(1.1);
        }
        button:active {
            transform: scale(0.98);
        }
        #play2Button {
            background-image: url('2Player2.png');
        }
        #play4Button {
            background-image: url('4Player2.png');
        }
        #playButton {
            background-image: url('start2.png');
            display: none;
        }
        #tournamentButton {
            background-image: url('tournament2.png');
            display: none;
            width: 200px;
            height: 90px;
        }
        #quitButton {
            background-image: url('quit2.png');
        }
        #mainMenuButton {
            background-image: url('mainMenu2.png');
            display: none;
            order: -1;
            transition: transform 0.2s ease, filter 0.2s ease;
        }
        #mainMenuButton:hover {
            transform: scale(1.08);
            filter: brightness(1.1);
        }
        #rematchButton {
            background-image: url('rematch.png');
        }
        #quitGameButton {
            background-image: url('quit2.png');
        }
        #undoButton {
            background-image: url('undoTurn2.png');
            display: none;
            order: 2;
            transition: transform 0.2s ease, filter 0.2s ease;
        }
        #undoButton:hover {
            transform: scale(1.08);
            filter: brightness(1.1);
        }
        #quitGameplayButton {
            background-image: url('quitGame.png');
            display: none;
            order: -1;
            transition: transform 0.2s ease, filter 0.2s ease;
        }
        #quitGameplayButton:hover {
            transform: scale(1.08);
            filter: brightness(1.1);
        }
        .stone {
            pointer-events: none;
        }
        #winScreenMessage, #tournamentWinner {
            color: #d4a373;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            font-size: 60px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 6px 15px rgba(0, 0, 0, 0.8), 0 2px 4px rgba(255, 215, 0, 0.3);
            letter-spacing: 1px;
        }
        #scoreDisplay, #finalScores {
            color: #FFD700;
            font-size: 20px;
            margin-top: 25px;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            font-weight: 500;
            line-height: 2;
        }
        .captured-stones {
            display: flex;
            flex-wrap: wrap;
            max-width: 150px;
            margin-top: 0px;
        }
        .captured-stone {
            width: 20px;
            height: 20px;
            transition: transform 0.5s ease-in-out;
        }
        #blueScore { color: #6666FF; }
        #redScore { color: #FF6666; }
        #yellowScore { color: #FFFF00; }
        #greenScore { color: #00FF00; }
        /* Modified CSS for sound toggle button */
        #soundToggleButton {
            font-size: 20px;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: transparent;
            color: white;
            border: none;
            padding: 0;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease;
            margin: 0;
            position: relative;
            order: -1;
            border-radius: 8px;
            width: 60px;
            height: 60px;
            min-width: 60px;
            min-height: 60px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            flex-shrink: 0;
            background-image: url('sound2.png');
        }
        #soundToggleButton:hover {
            transform: scale(1.08);
        }
        /* Back button shown on player-selection to return to main menu */
        #backButton {
            padding: 0;
            font-size: 22px;
            cursor: pointer;
            background-color: transparent;
            color: white;
            border: none;
            display: none;
            margin: 10px;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            background-image: url('back.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            transition: transform 0.2s ease, filter 0.2s ease;
            width: 160px;
            height: 80px;
        }
        #backButton:hover {
            transform: scale(1.08);
            filter: brightness(1.1);
        }
        /* Main menu title */
        #main-title {
            color: #d4a373;
            font-size: 56px;
            margin: 20px 0 40px 0;
            text-align: center;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.7), 0 2px 4px rgba(212, 163, 115, 0.3);
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            pointer-events: none;
            font-weight: 700;
            letter-spacing: 1px;
        }
        /* Inspired by note fixed bottom-right so it shows on setup and game screens */
        #inspiredBy {
            position: fixed;
            right: 20px;
            bottom: 15px;
            color: #d4a373;
            font-size: 26px;
            font-weight: 700;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            opacity: 1;
            pointer-events: none;
            text-align: center;
            background: rgba(0, 0, 0, 0.55);
            padding: 10px 15px;
            border-radius: 10px;
            text-shadow: 0 3px 8px rgba(0, 0, 0, 0.8);
            z-index: 9999;
            letter-spacing: 0.3px;
        }
    </style>
</head>
<body>

<div id="mainContent">
<div class="game-container" id="nameEntryScreen">
    <h1 id="main-title">Glass Bead Capture</h1>
    <div class="name-entry" id="player1Entry">
        <label for="player1Name">Enter Player 1's name <img src="stone.png" alt="Blue stone" style="width:20px;height:20px;vertical-align:middle;margin-left:6px;">: <br></label>
        <input type="text" id="player1Name" placeholder="Player 1" maxlength="8" />
    </div>
    <div class="name-entry" id="player2Entry">
        <label for="player2Name">Enter Player 2's name <img src="stone2.png" alt="Red stone" style="width:20px;height:20px;vertical-align:middle;margin-left:6px;">: <br></label>
        <input type="text" id="player2Name" placeholder="Player 2" maxlength="8" />
    </div>
    <div class="name-entry" id="player3Entry">
        <label for="player3Name">Enter Player 3's name <img src="stone3.png" alt="Yellow stone" style="width:20px;height:20px;vertical-align:middle;margin-left:6px;">: <br></label>
        <input type="text" id="player3Name" placeholder="Player 3" maxlength="8" />
    </div>
    <div class="name-entry" id="player4Entry">
        <label for="player4Name">Enter Player 4's name <img src="stone4.png" alt="Green stone" style="width:20px;height:20px;vertical-align:middle;margin-left:6px;">: <br></label>
        <input type="text" id="player4Name" placeholder="Player 4" maxlength="8" />
    </div>
    <div id="mainButtonRow">
        <button id="play2Button" onclick="showPlayers(2)"></button>
        <button id="play4Button" onclick="showPlayers(4)"></button>
    </div>
    <div id="playButtonContainer">
        <button id="playButton" onclick="startGame(false)"></button>
        <div class="button-with-info">
            <button id="tournamentButton" onclick="startGame(true)"></button>
            <div class="info-icon" onclick="showTournamentInfo()" title="What is Tournament Mode?">?</div>
        </div>
        <button id="backButton" aria-label="Back" onclick="backToMenu()"></button>
    </div>
    <div id="quitButtonRow">
        <button id="quitButton" onclick="quitGameCompletely()"></button>
    </div>
</div>

<div class="game-container" id="gameScreen" style="display:none;">
    <svg id="grid" width="800" height="800">
        <image id="boardImage" href="board.png" x="0" y="0" width="800" height="800" />
    </svg>
    <p id="winMessage"></p>
</div>

</div>

<div id="buttonColumn">
<h2 id="turnDisplay"></h2>
<div id="scoreboard" class="scoreboard">
    <p>Captured Pairs</p>
    <div class="score-item">
        <p id="blueScore">Blue: <span id="blueCaptured">0</span></p>
        <div id="blueCapturedStones" class="captured-stones"></div>
    </div>
    <div class="score-item">
        <p id="redScore">Red: <span id="redCaptured">0</span></p>
        <div id="redCapturedStones" class="captured-stones"></div>
    </div>
    <div class="score-item">
        <p id="yellowScore">Yellow: <span id="yellowCaptured">0</span></p>
        <div id="yellowCapturedStones" class="captured-stones"></div>
    </div>
    <div class="score-item">
        <p id="greenScore">Green: <span id="greenCaptured">0</span></p>
        <div id="greenCapturedStones" class="captured-stones"></div>
    </div>
    <div class="button-group">
        <button id="undoButton" onclick="undoTurn()"></button>
        <button id="soundToggleButton" onclick="toggleSound()"></button>
        <button id="mainMenuButton" onclick="quitToMainMenu()"></button>
    </div>
</div>
</div>

<div id="winScreen">
    <div id="winOverlay">
        <h1 id="winScreenMessage">Player Wins!</h1>
        <p id="winDetails">Win Condition</p>
        <div id="scoreDisplay"></div>
        <div id="winButtonsContainer">
            <button id="rematchButton" onclick="rematch()"></button>
            <button id="quitGameButton" onclick="quitGame()"></button>
        </div>
    </div>
</div>

<div id="tournamentEndScreen">
    <h2 id="tournamentWinner"></h2>
    <div id="finalScores"></div>
    <button id="quitGameButton" onclick="quitGame()"></button>
</div>

<div id="infoModal" onclick="closeModalIfOutside(event)">
    <div id="infoModalContent">
        <span class="close-modal" onclick="closeTournamentInfo()">&times;</span>
        <h2>Tournament Mode</h2>
        <p>Tournament Mode is a competitive series where you play <strong>5 games</strong> in a row with point tracking!</p>
        <p><strong>How Scoring Works:</strong></p>
        <ul>
            <li><strong>Win by 5-in-a-row:</strong> +15 points (5 base + 10 bonus)</li>
            <li><strong>Win by capturing 5 pairs:</strong> +5 points</li>
            <li><strong>Each captured pair:</strong> +1 point</li>
        </ul>
        <p>After 5 games, the player with the most total points wins the tournament!</p>
        <p>Perfect for competitive play sessions with friends or family.</p>
    </div>
</div>

<audio id="placeSound" src="place.mp3" preload="auto"></audio>
<audio id="captureSound" src="capture.mp3" preload="auto"></audio>
<audio id="winSound" src="win.mp3" preload="auto"></audio>

<div id="inspiredBy">Inspired by Pente</div>

<script>
    const size = 19;
    const spacing = 40;
    const stoneSize = 30;
    const boardOffset = spacing;
    const svg = document.getElementById("grid");
    const placedStones = new Map();
    let currentPlayer = 0;
    let players = [];
    let captures = { blue: 0, red: 0, yellow: 0, green: 0 };
    let scores = { blue: 0, red: 0, yellow: 0, green: 0 };
    let gameOver = false;
    let playerCount = 0;
    let isTournament = false;
    let tournamentGameCount = 0;
    const maxTournamentGames = 5;
    let moveHistory = [];

    const boardImage = document.getElementById("boardImage");
    const stoneColors = ["blue", "red", "yellow", "green"];
    const stoneImages = ["stone.png", "stone2.png", "stone3.png", "stone4.png"];
    const turnColors = ["#6666FF", "#FF6666", "#FFFF00", "#00FF00"];

    const placeSound = document.getElementById("placeSound");
    const captureSound = document.getElementById("captureSound");
    const winSound = document.getElementById("winSound");

    function showPlayers(numPlayers) {
        playerCount = numPlayers;
        document.getElementById("main-title").style.display = "none";
        document.getElementById("player1Entry").style.display = "block";
        document.getElementById("player2Entry").style.display = "block";
        document.getElementById("player3Entry").style.display = numPlayers === 4 ? "block" : "none";
        document.getElementById("player4Entry").style.display = numPlayers === 4 ? "block" : "none";
        document.getElementById("playButton").style.display = "block";
        document.getElementById("tournamentButton").style.display = "block";
        document.querySelector(".info-icon").style.display = "flex";
        document.getElementById("play2Button").style.display = "none";
        document.getElementById("play4Button").style.display = "none";
        document.getElementById("backButton").style.display = "inline-block";
    }

    function backToMenu() {
        document.getElementById("main-title").style.display = "block";
        document.getElementById("player1Entry").style.display = "none";
        document.getElementById("player2Entry").style.display = "none";
        document.getElementById("player3Entry").style.display = "none";
        document.getElementById("player4Entry").style.display = "none";
        document.getElementById("playButton").style.display = "none";
        document.getElementById("tournamentButton").style.display = "none";
        document.querySelector(".info-icon").style.display = "none";
        document.getElementById("play2Button").style.display = "inline-block";
        document.getElementById("play4Button").style.display = "inline-block";
        document.getElementById("backButton").style.display = "none";
    }

    function startGame(tournamentMode) {
        isTournament = tournamentMode;
           currentPlayer = 0;
        document.getElementById("backButton").style.display = "none";
        tournamentGameCount = 0;
        scores = { blue: 0, red: 0, yellow: 0, green: 0 };
        players = [];
        players.push(document.getElementById("player1Name").value || "Player 1");
        players.push(document.getElementById("player2Name").value || "Player 2");
        if (playerCount === 4) {
            players.push(document.getElementById("player3Name").value || "Player 3");
            players.push(document.getElementById("player4Name").value || "Player 4");
        }

        document.getElementById("nameEntryScreen").style.opacity = "0";
        setTimeout(() => {
            document.getElementById("nameEntryScreen").style.display = "none";
            document.getElementById("gameScreen").style.display = "block";
            document.getElementById("gameScreen").style.opacity = "1";
            document.getElementById("scoreboard").style.display = "block";
            document.getElementById("turnDisplay").style.display = "block";
            document.getElementById("undoButton").style.display = "block";
            document.getElementById("mainMenuButton").style.display = "block";
            updateTurnDisplay();
        }, 500);
    }

    function updateTurnDisplay() {
        document.getElementById("turnDisplay").innerText = `${players[currentPlayer]}'s Turn`;
        document.getElementById("turnDisplay").style.color = turnColors[currentPlayer];
        document.getElementById("yellowScore").parentElement.style.display = playerCount === 4 ? "block" : "none";
        document.getElementById("greenScore").parentElement.style.display = playerCount === 4 ? "block" : "none";
    }

    function updateScoreboard() {
        document.getElementById("blueCaptured").innerText = captures.blue;
        document.getElementById("redCaptured").innerText = captures.red;
        document.getElementById("yellowCaptured").innerText = captures.yellow;
        document.getElementById("greenCaptured").innerText = captures.green;
    }

    function updateScores(winnerIndex, winByRow) {
        if (!isTournament) return;
        const winnerColor = stoneColors[winnerIndex];
        scores[winnerColor] += 5;
        if (winByRow) {
            scores[winnerColor] += 10;
        }
        scores.blue += captures.blue;
        scores.red += captures.red;
        if (playerCount === 4) {
            scores.yellow += captures.yellow;
            scores.green += captures.green;
        }
    }

    function displayScores() {
        if (!isTournament) return;
        let scoreText = `Game ${tournamentGameCount} Scores:<br>`;
        scoreText += `${players[0]} (Blue): ${scores.blue}<br>`;
        scoreText += `${players[1]} (Red): ${scores.red}<br>`;
        if (playerCount === 4) {
            scoreText += `${players[2]} (Yellow): ${scores.yellow}<br>`;
            scoreText += `${players[3]} (Green): ${scores.green}<br>`;
        }
        document.getElementById("scoreDisplay").innerHTML = scoreText;
    }

    function endTournament() {
        let maxScore = -1;
        let tournamentWinner = "";
        for (let i = 0; i < playerCount; i++) {
            const color = stoneColors[i];
            if (scores[color] > maxScore) {
                maxScore = scores[color];
                tournamentWinner = players[i];
            }
        }
        document.getElementById("tournamentWinner").innerText = `${tournamentWinner} Wins the Tournament!`;
        let finalScoreText = "Final Scores:<br>";
        finalScoreText += `${players[0]} (Blue): ${scores.blue}<br>`;
        finalScoreText += `${players[1]} (Red): ${scores.red}<br>`;
        if (playerCount === 4) {
            finalScoreText += `${players[2]} (Yellow): ${scores.yellow}<br>`;
            finalScoreText += `${players[3]} (Green): ${scores.green}<br>`;
        }
        document.getElementById("finalScores").innerHTML = finalScoreText;
        document.getElementById("gameScreen").style.opacity = "0";
        setTimeout(() => {
            document.getElementById("gameScreen").style.display = "none";
            document.getElementById("winScreen").style.display = "none";
            document.getElementById("tournamentEndScreen").style.display = "block";
            document.getElementById("tournamentEndScreen").style.opacity = "0";
            document.getElementById("turnDisplay").style.display = "none";
            document.getElementById("undoButton").style.display = "none";
            setTimeout(() => document.getElementById("tournamentEndScreen").style.opacity = "1", 10);
        }, 500);
    }

    function placeStone(x, y) {
        if (gameOver) return;

        const minPos = boardOffset;
        const maxPos = boardOffset + (size - 1) * spacing;

        if (x < minPos || x > maxPos || y < minPos || y > maxPos) return;

        let key = `${x}-${y}`;
        if (placedStones.has(key)) return;

        let stone = document.createElementNS("http://www.w3.org/2000/svg", "image");
        let color = stoneColors[currentPlayer];
        stone.setAttribute("x", x - stoneSize / 2);
        stone.setAttribute("y", y - stoneSize / 2);
        stone.setAttribute("width", stoneSize);
        stone.setAttribute("height", stoneSize);
        stone.setAttribute("href", stoneImages[currentPlayer]);
        stone.setAttribute("class", "stone");
        svg.appendChild(stone);
        placedStones.set(key, { element: stone, color });

        let move = {
            player: currentPlayer,
            key: key,
            capturesBefore: { ...captures },
            capturedStones: [],
            stonesBeforeCapture: new Map(placedStones)
        };

        let captureOccurred = checkCapture(x, y, color);
        if (captureOccurred) {
            move.capturedStones = Array.from(move.stonesBeforeCapture.entries())
                .filter(([k, v]) => !placedStones.has(k))
                .map(([k, v]) => {
                    let stone = v.element;
                    return { 
                        key: k, 
                        x: parseFloat(stone.getAttribute("x")),
                        y: parseFloat(stone.getAttribute("y")),
                        color: v.color 
                    };
                });
        }

        moveHistory.push(move);

        if (!captureOccurred) {
            placeSound.currentTime = 0;
            placeSound.play();
        }

        checkWin(x, y, color);

        currentPlayer = (currentPlayer + 1) % playerCount;
        updateTurnDisplay();
    }

    function checkCapture(x, y, color) {
        let enemyColors = stoneColors.filter(c => c !== color);
        let directions = [
            { dx: spacing, dy: 0 },
            { dx: 0, dy: spacing },
            { dx: spacing, dy: spacing },
            { dx: spacing, dy: -spacing }
        ];

        let captured = false;

        directions.forEach(({ dx, dy }) => {
            let mid1 = `${x + dx}-${y + dy}`;
            let mid2 = `${x + 2 * dx}-${y + 2 * dy}`;
            let cap = `${x + 3 * dx}-${y + 3 * dy}`;

            let mid3 = `${x - dx}-${y - dy}`;
            let mid4 = `${x - 2 * dx}-${y - 2 * dy}`;
            let cap2 = `${x - 3 * dx}-${y - 3 * dy}`;

            if (placedStones.has(mid1) && placedStones.has(mid2) && placedStones.has(cap)) {
                if (enemyColors.includes(placedStones.get(mid1).color) &&
                    enemyColors.includes(placedStones.get(mid2).color) &&
                    placedStones.get(cap).color === color) {
                    captureStones([mid1, mid2], color);
                    captured = true;
                }
            }
            if (placedStones.has(mid3) && placedStones.has(mid4) && placedStones.has(cap2)) {
                if (enemyColors.includes(placedStones.get(mid3).color) &&
                    enemyColors.includes(placedStones.get(mid4).color) &&
                    placedStones.get(cap2).color === color) {
                    captureStones([mid3, mid4], color);
                    captured = true;
                }
            }
        });

        if (captured) {
            captureSound.currentTime = 0;
            captureSound.play();
        }

        // Check for capture-based win (5 or more pairs captured)
        if (captures.blue >= 5) return triggerWin(0, "capture");
        if (captures.red >= 5) return triggerWin(1, "capture");
        if (playerCount === 4) {
            if (captures.yellow >= 5) return triggerWin(2, "capture");
            if (captures.green >= 5) return triggerWin(3, "capture");
        }

        return captured;
    }

    function checkWin(x, y, color) {
        // Check for 5-in-a-row win (Pente rule)
        let directions = [
            { dx: spacing, dy: 0 },      // Horizontal
            { dx: 0, dy: spacing },      // Vertical
            { dx: spacing, dy: spacing }, // Diagonal \
            { dx: spacing, dy: -spacing } // Diagonal /
        ];

        const winCondition = playerCount === 4 ? 4 : 5;

        for (let { dx, dy } of directions) {
            let count = 1;

            // Count in both directions from placed stone
            for (let dir of [-1, 1]) {
                let step = 1;
                while (true) {
                    let nx = x + step * dx * dir;
                    let ny = y + step * dy * dir;
                    let key = `${nx}-${ny}`;
                    if (placedStones.has(key) && placedStones.get(key).color === color) {
                        count++;
                        step++;
                    } else {
                        break;
                    }
                }
            }

            // Win condition met
            if (count >= winCondition) {
                triggerWin(currentPlayer, "row");
                return;
            }
        }
    }

    function captureStones(keys, capturingColor) {
        const scoreboard = document.getElementById("scoreboard");
        const capturedContainer = document.getElementById(`${capturingColor}CapturedStones`);

        keys.forEach(key => {
            let stone = placedStones.get(key).element;
            let capturedStoneColor = placedStones.get(key).color;
            let stoneImage = stone.getAttribute("href");

            let startX = parseFloat(stone.getAttribute("x")) + stoneSize / 2;
            let startY = parseFloat(stone.getAttribute("y")) + stoneSize / 2;

            let animatedStone = document.createElement("img");
            animatedStone.src = stoneImage;
            animatedStone.classList.add("captured-stone");
            animatedStone.style.position = "absolute";
            animatedStone.style.left = `${startX + svg.getBoundingClientRect().left}px`;
            animatedStone.style.top = `${startY + svg.getBoundingClientRect().top}px`;
            document.body.appendChild(animatedStone);

            svg.removeChild(stone);
            placedStones.delete(key);

            let targetRect = capturedContainer.getBoundingClientRect();
            let targetX = targetRect.left + (captures[capturingColor] % 5) * 25;
            let targetY = targetRect.top + Math.floor(captures[capturingColor] / 5) * 25;

            requestAnimationFrame(() => {
                animatedStone.style.transform = `translate(${targetX - startX - svg.getBoundingClientRect().left}px, ${targetY - startY - svg.getBoundingClientRect().top}px)`;
                setTimeout(() => {
                    animatedStone.style.position = "static";
                    animatedStone.style.transform = "none";
                    capturedContainer.appendChild(animatedStone);
                }, 500);
            });
        });

        captures[capturingColor] = (captures[capturingColor] || 0) + 1;
        updateScoreboard();
    }

    function undoTurn() {
        if (gameOver || moveHistory.length === 0) return;

        let lastMove = moveHistory.pop();
        let { player, key, capturesBefore, capturedStones } = lastMove;

        if (placedStones.has(key)) {
            let stone = placedStones.get(key).element;
            svg.removeChild(stone);
            placedStones.delete(key);
        }

        capturedStones.forEach(({ key, x, y, color }) => {
            let restoredStone = document.createElementNS("http://www.w3.org/2000/svg", "image");
            restoredStone.setAttribute("x", x);
            restoredStone.setAttribute("y", y);
            restoredStone.setAttribute("width", stoneSize);
            restoredStone.setAttribute("height", stoneSize);
            restoredStone.setAttribute("href", stoneImages[stoneColors.indexOf(color)]);
            restoredStone.setAttribute("class", "stone");
            svg.appendChild(restoredStone);
            placedStones.set(key, { element: restoredStone, color });
        });

        stoneColors.forEach(color => {
            let container = document.getElementById(`${color}CapturedStones`);
            let targetCount = capturesBefore[color] * 2; // Each pair is 2 stones
            while (container.children.length > targetCount) {
                container.removeChild(container.lastChild);
            }
        });

        captures = { ...capturesBefore };
        updateScoreboard();

        currentPlayer = player;
        updateTurnDisplay();
    }

    function triggerWin(winnerIndex, winType) {
        // winType: "row" for 5-in-a-row, "capture" for 5+ pairs captured
        gameOver = true;
        endGame(winnerIndex, winType);
    }

    function endGame(winnerIndex, winType) {
        // Hide game screen and buttons
        document.getElementById("gameScreen").style.opacity = "0";
        setTimeout(() => {
            document.getElementById("gameScreen").style.display = "none";
            document.getElementById("scoreboard").style.display = "none";
            document.getElementById("turnDisplay").style.display = "none";
            document.getElementById("undoButton").style.display = "none";
            document.getElementById("mainMenuButton").style.display = "none";

            // Show win screen
            document.getElementById("winScreen").style.display = "block";
            document.getElementById("winScreen").style.opacity = "0";
            
            // Populate win screen with player name and win info
            let winMessage = `${players[winnerIndex]} Wins!`;
            let winDetails = "";
            
            if (winType === "row") {
                winDetails = `${playerCount === 4 ? "4" : "5"} in a Row`;
            } else if (winType === "capture") {
                winDetails = `Captured ${captures[stoneColors[winnerIndex]]} Pairs`;
            }
            
            document.getElementById("winScreenMessage").innerText = winMessage;
            document.getElementById("winDetails").innerText = winDetails;
            
            // Update scores display for end screen with visual beads
            let scoreHTML = `<div id="capturesGrid">`;
            
            // Display each player's captures
            for (let i = 0; i < playerCount; i++) {
                const color = stoneColors[i];
                const playerName = players[i];
                const captureCount = captures[color];
                const stoneImage = stoneImages[i];
                
                scoreHTML += `<div class="playerCaptureBox">
                    <p style="font-size: 20px; color: ${turnColors[i]}; margin: 5px 0;">${playerName}</p>
                    <div class="captureBeads">`;
                
                // Create grid of pairs (each pair = 2 beads)
                for (let j = 0; j < captureCount; j++) {
                    scoreHTML += `<div class="capturePair">
                        <img src="${stoneImage}" alt="pair" style="width: 25px; height: 25px;">
                        <img src="${stoneImage}" alt="pair" style="width: 25px; height: 25px;">
                    </div>`;
                }
                
                scoreHTML += `</div>
                </div>`;
            }
            
            scoreHTML += `</div>`;
            document.getElementById("scoreDisplay").innerHTML = scoreHTML;
            
            // Play win sound and fade in
            winSound.currentTime = 0;
            winSound.play();
            
            setTimeout(() => {
                document.getElementById("winScreen").style.opacity = "1";
            }, 10);
        }, 500);
    }

    function rematch() {
        gameOver = false;
        placedStones.clear();
        captures = { blue: 0, red: 0, yellow: 0, green: 0 };
        moveHistory = [];
        updateScoreboard();

        // Clear captured stones display
        document.getElementById("blueCapturedStones").innerHTML = "";
        document.getElementById("redCapturedStones").innerHTML = "";
        document.getElementById("yellowCapturedStones").innerHTML = "";
        document.getElementById("greenCapturedStones").innerHTML = "";

        // Clear board
        svg.innerHTML = '';
        svg.appendChild(boardImage);

        // Reset to first player
        currentPlayer = 0;
        updateTurnDisplay();

        // Fade out win screen, fade in game screen
        document.getElementById("winScreen").style.opacity = "0";
        setTimeout(() => {
            document.getElementById("winScreen").style.display = "none";
            document.getElementById("gameScreen").style.display = "block";
            document.getElementById("gameScreen").style.opacity = "0";
            document.getElementById("scoreboard").style.display = "block";
            document.getElementById("turnDisplay").style.display = "block";
            document.getElementById("undoButton").style.display = "block";
            document.getElementById("mainMenuButton").style.display = "block";
            setTimeout(() => document.getElementById("gameScreen").style.opacity = "1", 10);
        }, 500);
    }

    function quitGameplay() {
        document.getElementById("gameScreen").style.opacity = "0";
        setTimeout(() => {
            document.getElementById("gameScreen").style.display = "none";
            document.getElementById("turnDisplay").style.display = "none";
            document.getElementById("undoButton").style.display = "none";
            document.getElementById("quitGameplayButton").style.display = "none";
            document.getElementById("mainMenuButton").style.display = "none";
            
            gameOver = false;
            placedStones.clear();
            captures = { blue: 0, red: 0, yellow: 0, green: 0 };
            moveHistory = [];
            updateScoreboard();
            
            document.getElementById("blueCapturedStones").innerHTML = "";
            document.getElementById("redCapturedStones").innerHTML = "";
            document.getElementById("yellowCapturedStones").innerHTML = "";
            document.getElementById("greenCapturedStones").innerHTML = "";
            
            svg.innerHTML = '';
            svg.appendChild(boardImage);
            
            document.getElementById("nameEntryScreen").style.display = "block";
            document.getElementById("nameEntryScreen").style.opacity = "1";
            document.getElementById("scoreboard").style.display = "none";
        }, 500);
    }

    function quitToMainMenu() {
        document.getElementById("gameScreen").style.opacity = "0";
        setTimeout(() => {
            document.getElementById("gameScreen").style.display = "none";
            document.getElementById("turnDisplay").style.display = "none";
            document.getElementById("undoButton").style.display = "none";
            document.getElementById("mainMenuButton").style.display = "none";
            
            gameOver = false;
            placedStones.clear();
            captures = { blue: 0, red: 0, yellow: 0, green: 0 };
            moveHistory = [];
            scores = { blue: 0, red: 0, yellow: 0, green: 0 };
            updateScoreboard();
            
            document.getElementById("blueCapturedStones").innerHTML = "";
            document.getElementById("redCapturedStones").innerHTML = "";
            document.getElementById("yellowCapturedStones").innerHTML = "";
            document.getElementById("greenCapturedStones").innerHTML = "";
            
            svg.innerHTML = '';
            svg.appendChild(boardImage);
            
            document.getElementById("player1Name").value = "";
            document.getElementById("player2Name").value = "";
            document.getElementById("player3Name").value = "";
            document.getElementById("player4Name").value = "";
            
            document.getElementById("main-title").style.display = "block";
            document.getElementById("player1Entry").style.display = "none";
            document.getElementById("player2Entry").style.display = "none";
            document.getElementById("player3Entry").style.display = "none";
            document.getElementById("player4Entry").style.display = "none";
            document.getElementById("playButton").style.display = "none";
            document.getElementById("tournamentButton").style.display = "none";
            document.querySelector(".info-icon").style.display = "none";
            document.getElementById("backButton").style.display = "none";
            document.getElementById("play2Button").style.display = "inline-block";
            document.getElementById("play4Button").style.display = "inline-block";
            
            document.getElementById("nameEntryScreen").style.display = "block";
            document.getElementById("nameEntryScreen").style.opacity = "1";
            document.getElementById("scoreboard").style.display = "none";
        }, 500);
    }

    function quitGame() {
        gameOver = false;
        placedStones.clear();
        captures = { blue: 0, red: 0, yellow: 0, green: 0 };
        moveHistory = [];
        scores = { blue: 0, red: 0, yellow: 0, green: 0 };
        updateScoreboard();
        
        document.getElementById("blueCapturedStones").innerHTML = "";
        document.getElementById("redCapturedStones").innerHTML = "";
        document.getElementById("yellowCapturedStones").innerHTML = "";
        document.getElementById("greenCapturedStones").innerHTML = "";
        
        svg.innerHTML = '';
        svg.appendChild(boardImage);
        
        document.getElementById("player1Name").value = "";
        document.getElementById("player2Name").value = "";
        document.getElementById("player3Name").value = "";
        document.getElementById("player4Name").value = "";
        
        document.getElementById("winScreen").style.opacity = "0";
        setTimeout(() => {
            document.getElementById("gameScreen").style.display = "none";
            document.getElementById("winScreen").style.display = "none";
            document.getElementById("scoreboard").style.display = "none";
            
            // Reset player selection to initial state
            document.getElementById("player1Entry").style.display = "none";
            document.getElementById("player2Entry").style.display = "none";
            document.getElementById("player3Entry").style.display = "none";
            document.getElementById("player4Entry").style.display = "none";
            document.getElementById("playButton").style.display = "none";
            document.getElementById("tournamentButton").style.display = "none";
            document.querySelector(".info-icon").style.display = "none";
            document.getElementById("backButton").style.display = "none";
            document.getElementById("play2Button").style.display = "inline-block";
            document.getElementById("play4Button").style.display = "inline-block";
            document.getElementById("main-title").style.display = "block";
            
            document.getElementById("nameEntryScreen").style.display = "block";
            document.getElementById("nameEntryScreen").style.opacity = "1";
            document.getElementById("turnDisplay").style.display = "none";
            document.getElementById("undoButton").style.display = "none";
            document.getElementById("mainMenuButton").style.display = "none";
        }, 500);
    }

    function quitGameCompletely() {
        document.getElementById("nameEntryScreen").style.opacity = "0";
        setTimeout(() => window.close(), 500);
    }

    svg.addEventListener("click", (event) => {
        let rect = svg.getBoundingClientRect();
        let clickX = event.clientX - rect.left;
        let clickY = event.clientY - rect.top;

        let snappedX = Math.round((clickX - boardOffset) / spacing) * spacing + boardOffset;
        let snappedY = Math.round((clickY - boardOffset) / spacing) * spacing + boardOffset;

        placeStone(snappedX, snappedY);
    });

    /* New JavaScript additions for sound toggle */
    let isSoundOn = true;
function toggleSound() {
    isSoundOn = !isSoundOn;
    document.getElementById("soundToggleButton").style.backgroundImage = `url('${isSoundOn ? 'sound2.png' : 'mute2.png'}')`;
    placeSound.muted = !isSoundOn;
    captureSound.muted = !isSoundOn;
    winSound.muted = !isSoundOn;
}

function showTournamentInfo() {
    document.getElementById("infoModal").style.display = "flex";
}

function closeTournamentInfo() {
    document.getElementById("infoModal").style.display = "none";
}

function closeModalIfOutside(event) {
    if (event.target.id === "infoModal") {
        closeTournamentInfo();
    }
}
</script>

</body>
</html>
