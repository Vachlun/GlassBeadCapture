<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>19x19 Bead Capture Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            background-image: url('background.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            gap: 60px;
        }
        #mainContent {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #buttonColumn {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            align-items: center;
            justify-items: center;
            width: auto;
        }
        #playButtonContainer {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
            align-items: center;
            justify-items: center;
            width: auto;
            margin: 10px 0;
        }
        #mainButtonRow {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
            align-items: center;
            justify-items: center;
            width: auto;
            margin: 10px 0;
        }
        #quitButtonRow {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
            align-items: center;
            justify-items: center;
            width: auto;
            margin: 10px 0;
        }
        svg {
            border: 2px solid white;
            width: 800px;
            height: 800px;
        }
        .scoreboard {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: bold;
            display: none;
            color: #d4a373;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            padding: 15px;
            margin: 0;
            border-radius: 10px;
        }
        #turnDisplay {
            position: static;
            font-size: 24px;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            color: white;
            margin: 0;
            padding: 0;
        }
        #winMessage {
            font-size: 30px;
            color: green;
            font-weight: bold;
            display: none;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
        }
        #gameScreen {
            display: block;
            position: relative;
        }
        #winScreen, #tournamentEndScreen {
            display: none;
            text-align: center;
            transition: opacity 0.5s ease-in-out;
        }
        #winScreen {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            width: auto;
            opacity: 0;
        }
        #tournamentEndScreen {
            padding: 20px;
            border-radius: 10px;
        }
        #winOverlay {
            background: rgba(20, 20, 40, 0.95);
            border: 3px solid #d4a373;
            border-radius: 20px;
            padding: 80px 150px;
            text-align: center;
            max-width: 900px;
            box-shadow: 0 0 40px rgba(212, 163, 115, 0.5);
        }
        #winScreenMessage {
            font-size: 64px;
            font-weight: bold;
            color: #FFD700;
            margin: 0 0 15px 0;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.8);
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
        }
        #winDetails {
            font-size: 32px;
            color: #d4a373;
            margin: 0 0 25px 0;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
        }
        #scoreDisplay {
            color: white;
            font-size: 18px;
            margin: 25px 0;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.8;
        }
        #capturesGrid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .playerCaptureBox {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #d4a373;
            border-radius: 10px;
            padding: 15px;
        }
        .playerCaptureBox p {
            font-weight: bold;
            text-transform: uppercase;
        }
        .captureBeads {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            justify-items: center;
            margin-top: 10px;
        }
        .capturePair {
            display: flex;
            gap: 2px;
            align-items: center;
            justify-content: center;
        }
        #winButtonsContainer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 40px;
            justify-items: center;
        }
        #rematchButton, #quitGameButton {
            width: 160px;
            height: 100px;
            padding: 0;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: transparent;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        #rematchButton:hover, #quitGameButton:hover {
            transform: scale(1.1);
        }
        .name-entry {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            color: white;
            display: none;
        }
        input[type="text"] {
            padding: 8px;
            font-size: 16px;
            margin: 5px;
            color: white;
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid white;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
        }
        button {
            padding: 0;
            font-size: 22px;
            cursor: pointer;
            background-color: transparent;
            color: white;
            border: none;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            transition: transform 0.2s ease;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            z-index: 1;
            margin: 0;
            width: 160px;
            height: 100px;
        }
        button:hover {
            transform: scale(1.05);
            background-color: transparent;
        }
        #play2Button {
            background-image: url('play2.png');
        }
        #play4Button {
            background-image: url('play4.png');
        }
        #playButton {
            background-image: url('play.png');
            display: none;
        }
        #tournamentButton {
            background-image: url('tournament.png');
            display: none;
        }
        #quitButton {
            background-image: url('quit.png');
        }
        #rematchButton {
            background-image: url('rematch.png');
        }
        #quitGameButton {
            background-image: url('quitGame.png');
        }
        #undoButton {
            background-image: url('undo.png');
            padding: 30px 60px;
            display: none;
            order: 2;
        }
        #quitGameplayButton {
            background-image: url('quitGame.png');
            padding: 30px 60px;
            display: none;
            margin-top: 0;
            order: -1;
        }
        #mainMenuButton {
            background-image: url('mainMenu.png');
            padding: 30px 60px;
            display: none;
            margin-top: 0;
            order: -1;
        }
        .stone {
            pointer-events: none;
        }
        #winScreenMessage, #tournamentWinner {
            color: white;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        #scoreDisplay, #finalScores {
            color: white;
            font-size: 18px;
            margin-top: 10px;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
        }
        .captured-stones {
            display: flex;
            flex-wrap: wrap;
            max-width: 150px;
            margin-top: 5px;
        }
        .captured-stone {
            width: 20px;
            height: 20px;
            transition: transform 0.5s ease-in-out;
        }
        #blueScore { color: #6666FF; }
        #redScore { color: #FF6666; }
        #yellowScore { color: #FFFF00; }
        #greenScore { color: #00FF00; }
        /* Modified CSS for sound toggle button */
        #soundToggleButton {
            font-size: 20px;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: transparent;
            color: white;
            border: 1px solid white;
            padding: 5px 10px;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-top: 0;
            position: relative;
            order: -1;
        }
        #soundToggleButton:hover {
            transform: scale(1.05);
        }
        /* Back button shown on player-selection to return to main menu */
        #backButton {
            padding: 60px 120px;
            font-size: 22px;
            cursor: pointer;
            background-color: transparent;
            color: white;
            border: none;
            display: none;
            margin: 10px;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            background-image: url('back.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        /* Main menu title */
        #main-title {
            color: white;
            font-size: 48px;
            margin: 10px 0 20px 0;
            text-align: center;
            text-shadow: 0 3px 8px rgba(0,0,0,0.6);
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            pointer-events: none;
        }
        /* Inspired by note fixed bottom-right so it shows on setup and game screens */
        #inspiredBy {
            position: fixed;
            right: 18px;
            bottom: 12px;
            color: white;
            font-size: 24px;
            font-weight: 700;
            font-family: 'Baloo 2', 'Segoe UI', Roboto, Arial, sans-serif;
            opacity: 1;
            pointer-events: none;
            text-align: center;
            background: rgba(0,0,0,0.45);
            padding: 8px 12px;
            border-radius: 8px;
            text-shadow: 0 2px 6px rgba(0,0,0,0.7);
            z-index: 9999;
        }
    </style>
</head>
<body>

<div id="mainContent">
<div class="game-container" id="nameEntryScreen">
    <h1 id="main-title">Glass Bead Capture</h1>
    <div class="name-entry" id="player1Entry">
        <label for="player1Name">Enter Player 1's name <img src="stone.png" alt="Blue stone" style="width:20px;height:20px;vertical-align:middle;margin-left:6px;">: <br></label>
        <input type="text" id="player1Name" placeholder="Player 1" maxlength="12" />
    </div>
    <div class="name-entry" id="player2Entry">
        <label for="player2Name">Enter Player 2's name <img src="stone2.png" alt="Red stone" style="width:20px;height:20px;vertical-align:middle;margin-left:6px;">: <br></label>
        <input type="text" id="player2Name" placeholder="Player 2" maxlength="12" />
    </div>
    <div class="name-entry" id="player3Entry">
        <label for="player3Name">Enter Player 3's name <img src="stone3.png" alt="Yellow stone" style="width:20px;height:20px;vertical-align:middle;margin-left:6px;">: <br></label>
        <input type="text" id="player3Name" placeholder="Player 3" maxlength="12" />
    </div>
    <div class="name-entry" id="player4Entry">
        <label for="player4Name">Enter Player 4's name <img src="stone4.png" alt="Green stone" style="width:20px;height:20px;vertical-align:middle;margin-left:6px;">: <br></label>
        <input type="text" id="player4Name" placeholder="Player 4" maxlength="12" />
    </div>
    <div id="mainButtonRow">
        <button id="play2Button" onclick="showPlayers(2)"></button>
        <button id="play4Button" onclick="showPlayers(4)"></button>
    </div>
    <div id="playButtonContainer">
        <button id="playButton" onclick="startGame(false)"></button>
        <button id="tournamentButton" onclick="startGame(true)"></button>
        <button id="backButton" aria-label="Back" onclick="backToMenu()"></button>
    </div>
    <div id="quitButtonRow">
        <button id="quitButton" onclick="quitGameCompletely()"></button>
    </div>
</div>

<div class="game-container" id="gameScreen" style="display:none;">
    <svg id="grid" width="800" height="800">
        <image id="boardImage" href="board.png" x="0" y="0" width="800" height="800" />
    </svg>
    <p id="winMessage"></p>
</div>

</div>

<div id="buttonColumn">
<h2 id="turnDisplay"></h2>
<div id="scoreboard" class="scoreboard">
    <p>Captured Pairs</p>
    <p id="blueScore">Blue: <span id="blueCaptured">0</span></p>
    <div id="blueCapturedStones" class="captured-stones"></div>
    <p id="redScore">Red: <span id="redCaptured">0</span></p>
    <div id="redCapturedStones" class="captured-stones"></div>
    <p id="yellowScore">Yellow: <span id="yellowCaptured">0</span></p>
    <div id="yellowCapturedStones" class="captured-stones"></div>
    <p id="greenScore">Green: <span id="greenCaptured">0</span></p>
    <div id="greenCapturedStones" class="captured-stones"></div>
    <button id="undoButton" onclick="undoTurn()"></button>
    <button id="soundToggleButton" onclick="toggleSound()" style="background-image: url('on.png'); width: 60px; height: 30px; background-size: contain; background-repeat: no-repeat; background-position: center; border: none; background-color: transparent; cursor: pointer;"></button>
    <button id="mainMenuButton" onclick="quitToMainMenu()"></button>
</div>
</div>

<div id="winScreen">
    <div id="winOverlay">
        <h1 id="winScreenMessage">Player Wins!</h1>
        <p id="winDetails">Win Condition</p>
        <div id="scoreDisplay"></div>
        <div id="winButtonsContainer">
            <button id="rematchButton" onclick="rematch()"></button>
            <button id="quitGameButton" onclick="quitGame()"></button>
        </div>
    </div>
</div>

<div id="tournamentEndScreen">
    <h2 id="tournamentWinner"></h2>
    <div id="finalScores"></div>
    <button id="quitGameButton" onclick="quitGame()"></button>
</div>


<audio id="placeSound" src="place.mp3" preload="auto"></audio>
<audio id="captureSound" src="capture.mp3" preload="auto"></audio>
<audio id="winSound" src="win.mp3" preload="auto"></audio>

<script>
    const size = 19;
    const spacing = 40;
    const stoneSize = 30;
    const boardOffset = spacing;
    const svg = document.getElementById("grid");
    const placedStones = new Map();
    let currentPlayer = 0;
    let players = [];
    let captures = { blue: 0, red: 0, yellow: 0, green: 0 };
    let scores = { blue: 0, red: 0, yellow: 0, green: 0 };
    let gameOver = false;
    let playerCount = 0;
    let isTournament = false;
    let tournamentGameCount = 0;
    const maxTournamentGames = 5;
    let moveHistory = [];

    const boardImage = document.getElementById("boardImage");
    const stoneColors = ["blue", "red", "yellow", "green"];
    const stoneImages = ["stone.png", "stone2.png", "stone3.png", "stone4.png"];
    const turnColors = ["#6666FF", "#FF6666", "#FFFF00", "#00FF00"];

    const placeSound = document.getElementById("placeSound");
    const captureSound = document.getElementById("captureSound");
    const winSound = document.getElementById("winSound");

    function showPlayers(numPlayers) {
        playerCount = numPlayers;
        document.getElementById("main-title").style.display = "none";
        document.getElementById("player1Entry").style.display = "block";
        document.getElementById("player2Entry").style.display = "block";
        document.getElementById("player3Entry").style.display = numPlayers === 4 ? "block" : "none";
        document.getElementById("player4Entry").style.display = numPlayers === 4 ? "block" : "none";
        document.getElementById("playButton").style.display = "block";
        document.getElementById("tournamentButton").style.display = "block";
        document.getElementById("play2Button").style.display = "none";
        document.getElementById("play4Button").style.display = "none";
        document.getElementById("backButton").style.display = "inline-block";
    }

    function backToMenu() {
        document.getElementById("main-title").style.display = "block";
        document.getElementById("player1Entry").style.display = "none";
        document.getElementById("player2Entry").style.display = "none";
        document.getElementById("player3Entry").style.display = "none";
        document.getElementById("player4Entry").style.display = "none";
        document.getElementById("playButton").style.display = "none";
        document.getElementById("tournamentButton").style.display = "none";
        document.getElementById("play2Button").style.display = "inline-block";
        document.getElementById("play4Button").style.display = "inline-block";
        document.getElementById("backButton").style.display = "none";
    }

    function startGame(tournamentMode) {
        isTournament = tournamentMode;
        document.getElementById("backButton").style.display = "none";
        tournamentGameCount = 0;
        scores = { blue: 0, red: 0, yellow: 0, green: 0 };
        players = [];
        players.push(document.getElementById("player1Name").value || "Player 1");
        players.push(document.getElementById("player2Name").value || "Player 2");
        if (playerCount === 4) {
            players.push(document.getElementById("player3Name").value || "Player 3");
            players.push(document.getElementById("player4Name").value || "Player 4");
        }

        document.getElementById("nameEntryScreen").style.opacity = "0";
        setTimeout(() => {
            document.getElementById("nameEntryScreen").style.display = "none";
            document.getElementById("gameScreen").style.display = "block";
            document.getElementById("gameScreen").style.opacity = "1";
            document.getElementById("scoreboard").style.display = "block";
            document.getElementById("turnDisplay").style.display = "block";
            document.getElementById("undoButton").style.display = "block";
            document.getElementById("mainMenuButton").style.display = "block";
            updateTurnDisplay();
        }, 500);
    }

    function updateTurnDisplay() {
        document.getElementById("turnDisplay").innerText = `${players[currentPlayer]}'s Turn`;
        document.getElementById("turnDisplay").style.color = turnColors[currentPlayer];
        document.getElementById("yellowCaptured").parentElement.style.display = playerCount === 4 ? "block" : "none";
        document.getElementById("greenCaptured").parentElement.style.display = playerCount === 4 ? "block" : "none";
    }

    function updateScoreboard() {
        document.getElementById("blueCaptured").innerText = captures.blue;
        document.getElementById("redCaptured").innerText = captures.red;
        document.getElementById("yellowCaptured").innerText = captures.yellow;
        document.getElementById("greenCaptured").innerText = captures.green;
    }

    function updateScores(winnerIndex, winByRow) {
        if (!isTournament) return;
        const winnerColor = stoneColors[winnerIndex];
        scores[winnerColor] += 5;
        if (winByRow) {
            scores[winnerColor] += 10;
        }
        scores.blue += captures.blue;
        scores.red += captures.red;
        if (playerCount === 4) {
            scores.yellow += captures.yellow;
            scores.green += captures.green;
        }
    }

    function displayScores() {
        if (!isTournament) return;
        let scoreText = `Game ${tournamentGameCount} Scores:<br>`;
        scoreText += `${players[0]} (Blue): ${scores.blue}<br>`;
        scoreText += `${players[1]} (Red): ${scores.red}<br>`;
        if (playerCount === 4) {
            scoreText += `${players[2]} (Yellow): ${scores.yellow}<br>`;
            scoreText += `${players[3]} (Green): ${scores.green}<br>`;
        }
        document.getElementById("scoreDisplay").innerHTML = scoreText;
    }

    function endTournament() {
        let maxScore = -1;
        let tournamentWinner = "";
        for (let i = 0; i < playerCount; i++) {
            const color = stoneColors[i];
            if (scores[color] > maxScore) {
                maxScore = scores[color];
                tournamentWinner = players[i];
            }
        }
        document.getElementById("tournamentWinner").innerText = `${tournamentWinner} Wins the Tournament!`;
        let finalScoreText = "Final Scores:<br>";
        finalScoreText += `${players[0]} (Blue): ${scores.blue}<br>`;
        finalScoreText += `${players[1]} (Red): ${scores.red}<br>`;
        if (playerCount === 4) {
            finalScoreText += `${players[2]} (Yellow): ${scores.yellow}<br>`;
            finalScoreText += `${players[3]} (Green): ${scores.green}<br>`;
        }
        document.getElementById("finalScores").innerHTML = finalScoreText;
        document.getElementById("gameScreen").style.opacity = "0";
        setTimeout(() => {
            document.getElementById("gameScreen").style.display = "none";
            document.getElementById("winScreen").style.display = "none";
            document.getElementById("tournamentEndScreen").style.display = "block";
            document.getElementById("tournamentEndScreen").style.opacity = "0";
            document.getElementById("turnDisplay").style.display = "none";
            document.getElementById("undoButton").style.display = "none";
            setTimeout(() => document.getElementById("tournamentEndScreen").style.opacity = "1", 10);
        }, 500);
    }

    function placeStone(x, y) {
        if (gameOver) return;

        const minPos = boardOffset;
        const maxPos = boardOffset + (size - 1) * spacing;

        if (x < minPos || x > maxPos || y < minPos || y > maxPos) return;

        let key = `${x}-${y}`;
        if (placedStones.has(key)) return;

        let stone = document.createElementNS("http://www.w3.org/2000/svg", "image");
        let color = stoneColors[currentPlayer];
        stone.setAttribute("x", x - stoneSize / 2);
        stone.setAttribute("y", y - stoneSize / 2);
        stone.setAttribute("width", stoneSize);
        stone.setAttribute("height", stoneSize);
        stone.setAttribute("href", stoneImages[currentPlayer]);
        stone.setAttribute("class", "stone");
        svg.appendChild(stone);
        placedStones.set(key, { element: stone, color });

        let move = {
            player: currentPlayer,
            key: key,
            capturesBefore: { ...captures },
            capturedStones: [],
            stonesBeforeCapture: new Map(placedStones)
        };

        let captureOccurred = checkCapture(x, y, color);
        if (captureOccurred) {
            move.capturedStones = Array.from(move.stonesBeforeCapture.entries())
                .filter(([k, v]) => !placedStones.has(k))
                .map(([k, v]) => {
                    let stone = v.element;
                    return { 
                        key: k, 
                        x: parseFloat(stone.getAttribute("x")),
                        y: parseFloat(stone.getAttribute("y")),
                        color: v.color 
                    };
                });
        }

        moveHistory.push(move);

        if (!captureOccurred) {
            placeSound.currentTime = 0;
            placeSound.play();
        }

        checkWin(x, y, color);

        currentPlayer = (currentPlayer + 1) % playerCount;
        updateTurnDisplay();
    }

    function checkCapture(x, y, color) {
        let enemyColors = stoneColors.filter(c => c !== color);
        let directions = [
            { dx: spacing, dy: 0 },
            { dx: 0, dy: spacing },
            { dx: spacing, dy: spacing },
            { dx: spacing, dy: -spacing }
        ];

        let captured = false;

        directions.forEach(({ dx, dy }) => {
            let mid1 = `${x + dx}-${y + dy}`;
            let mid2 = `${x + 2 * dx}-${y + 2 * dy}`;
            let cap = `${x + 3 * dx}-${y + 3 * dy}`;

            let mid3 = `${x - dx}-${y - dy}`;
            let mid4 = `${x - 2 * dx}-${y - 2 * dy}`;
            let cap2 = `${x - 3 * dx}-${y - 3 * dy}`;

            if (placedStones.has(mid1) && placedStones.has(mid2) && placedStones.has(cap)) {
                if (enemyColors.includes(placedStones.get(mid1).color) &&
                    enemyColors.includes(placedStones.get(mid2).color) &&
                    placedStones.get(cap).color === color) {
                    captureStones([mid1, mid2], color);
                    captured = true;
                }
            }
            if (placedStones.has(mid3) && placedStones.has(mid4) && placedStones.has(cap2)) {
                if (enemyColors.includes(placedStones.get(mid3).color) &&
                    enemyColors.includes(placedStones.get(mid4).color) &&
                    placedStones.get(cap2).color === color) {
                    captureStones([mid3, mid4], color);
                    captured = true;
                }
            }
        });

        if (captured) {
            captureSound.currentTime = 0;
            captureSound.play();
        }

        // Check for capture-based win (5 or more pairs captured)
        if (captures.blue >= 5) return triggerWin(0, "capture");
        if (captures.red >= 5) return triggerWin(1, "capture");
        if (playerCount === 4) {
            if (captures.yellow >= 5) return triggerWin(2, "capture");
            if (captures.green >= 5) return triggerWin(3, "capture");
        }

        return captured;
    }

    function checkWin(x, y, color) {
        // Check for 5-in-a-row win (Pente rule)
        let directions = [
            { dx: spacing, dy: 0 },      // Horizontal
            { dx: 0, dy: spacing },      // Vertical
            { dx: spacing, dy: spacing }, // Diagonal \
            { dx: spacing, dy: -spacing } // Diagonal /
        ];

        const winCondition = playerCount === 4 ? 4 : 5;

        for (let { dx, dy } of directions) {
            let count = 1;

            // Count in both directions from placed stone
            for (let dir of [-1, 1]) {
                let step = 1;
                while (true) {
                    let nx = x + step * dx * dir;
                    let ny = y + step * dy * dir;
                    let key = `${nx}-${ny}`;
                    if (placedStones.has(key) && placedStones.get(key).color === color) {
                        count++;
                        step++;
                    } else {
                        break;
                    }
                }
            }

            // Win condition met
            if (count >= winCondition) {
                triggerWin(currentPlayer, "row");
                return;
            }
        }
    }

    function captureStones(keys, capturingColor) {
        const scoreboard = document.getElementById("scoreboard");
        const capturedContainer = document.getElementById(`${capturingColor}CapturedStones`);

        keys.forEach(key => {
            let stone = placedStones.get(key).element;
            let capturedStoneColor = placedStones.get(key).color;
            let stoneImage = stone.getAttribute("href");

            let startX = parseFloat(stone.getAttribute("x")) + stoneSize / 2;
            let startY = parseFloat(stone.getAttribute("y")) + stoneSize / 2;

            let animatedStone = document.createElement("img");
            animatedStone.src = stoneImage;
            animatedStone.classList.add("captured-stone");
            animatedStone.style.position = "absolute";
            animatedStone.style.left = `${startX + svg.getBoundingClientRect().left}px`;
            animatedStone.style.top = `${startY + svg.getBoundingClientRect().top}px`;
            document.body.appendChild(animatedStone);

            svg.removeChild(stone);
            placedStones.delete(key);

            let targetRect = capturedContainer.getBoundingClientRect();
            let targetX = targetRect.left + (captures[capturingColor] % 5) * 25;
            let targetY = targetRect.top + Math.floor(captures[capturingColor] / 5) * 25;

            requestAnimationFrame(() => {
                animatedStone.style.transform = `translate(${targetX - startX - svg.getBoundingClientRect().left}px, ${targetY - startY - svg.getBoundingClientRect().top}px)`;
                setTimeout(() => {
                    animatedStone.style.position = "static";
                    animatedStone.style.transform = "none";
                    capturedContainer.appendChild(animatedStone);
                }, 500);
            });
        });

        captures[capturingColor] = (captures[capturingColor] || 0) + 1;
        updateScoreboard();
    }

    function undoTurn() {
        if (gameOver || moveHistory.length === 0) return;

        let lastMove = moveHistory.pop();
        let { player, key, capturesBefore, capturedStones } = lastMove;

        if (placedStones.has(key)) {
            let stone = placedStones.get(key).element;
            svg.removeChild(stone);
            placedStones.delete(key);
        }

        capturedStones.forEach(({ key, x, y, color }) => {
            let restoredStone = document.createElementNS("http://www.w3.org/2000/svg", "image");
            restoredStone.setAttribute("x", x);
            restoredStone.setAttribute("y", y);
            restoredStone.setAttribute("width", stoneSize);
            restoredStone.setAttribute("height", stoneSize);
            restoredStone.setAttribute("href", stoneImages[stoneColors.indexOf(color)]);
            restoredStone.setAttribute("class", "stone");
            svg.appendChild(restoredStone);
            placedStones.set(key, { element: restoredStone, color });
        });

        stoneColors.forEach(color => {
            let container = document.getElementById(`${color}CapturedStones`);
            while (container.children.length > capturesBefore[color]) {
                container.removeChild(container.lastChild);
            }
        });

        captures = { ...capturesBefore };
        updateScoreboard();

        currentPlayer = player;
        updateTurnDisplay();
    }

    function triggerWin(winnerIndex, winType) {
        // winType: "row" for 5-in-a-row, "capture" for 5+ pairs captured
        gameOver = true;
        endGame(winnerIndex, winType);
    }

    function endGame(winnerIndex, winType) {
        // Hide game screen and buttons
        document.getElementById("gameScreen").style.opacity = "0";
        setTimeout(() => {
            document.getElementById("gameScreen").style.display = "none";
            document.getElementById("scoreboard").style.display = "none";
            document.getElementById("turnDisplay").style.display = "none";
            document.getElementById("undoButton").style.display = "none";
            document.getElementById("mainMenuButton").style.display = "none";

            // Show win screen
            document.getElementById("winScreen").style.display = "block";
            document.getElementById("winScreen").style.opacity = "0";
            
            // Populate win screen with player name and win info
            let winMessage = `${players[winnerIndex]} Wins!`;
            let winDetails = "";
            
            if (winType === "row") {
                winDetails = `${playerCount === 4 ? "4" : "5"} in a Row`;
            } else if (winType === "capture") {
                winDetails = `Captured ${captures[stoneColors[winnerIndex]]} Pairs`;
            }
            
            document.getElementById("winScreenMessage").innerText = winMessage;
            document.getElementById("winDetails").innerText = winDetails;
            
            // Update scores display for end screen with visual beads
            let scoreHTML = `<div id="capturesGrid">`;
            
            // Display each player's captures
            for (let i = 0; i < playerCount; i++) {
                const color = stoneColors[i];
                const playerName = players[i];
                const captureCount = captures[color];
                const stoneImage = stoneImages[i];
                
                scoreHTML += `<div class="playerCaptureBox">
                    <p style="font-size: 20px; color: ${turnColors[i]}; margin: 5px 0;">${playerName}</p>
                    <div class="captureBeads">`;
                
                // Create grid of pairs (each pair = 2 beads)
                for (let j = 0; j < captureCount; j++) {
                    scoreHTML += `<div class="capturePair">
                        <img src="${stoneImage}" alt="pair" style="width: 25px; height: 25px;">
                        <img src="${stoneImage}" alt="pair" style="width: 25px; height: 25px;">
                    </div>`;
                }
                
                scoreHTML += `</div>
                </div>`;
            }
            
            scoreHTML += `</div>`;
            document.getElementById("scoreDisplay").innerHTML = scoreHTML;
            
            // Play win sound and fade in
            winSound.currentTime = 0;
            winSound.play();
            
            setTimeout(() => {
                document.getElementById("winScreen").style.opacity = "1";
            }, 10);
        }, 500);
    }

    function rematch() {
        gameOver = false;
        placedStones.clear();
        captures = { blue: 0, red: 0, yellow: 0, green: 0 };
        moveHistory = [];
        updateScoreboard();

        // Clear captured stones display
        document.getElementById("blueCapturedStones").innerHTML = "";
        document.getElementById("redCapturedStones").innerHTML = "";
        document.getElementById("yellowCapturedStones").innerHTML = "";
        document.getElementById("greenCapturedStones").innerHTML = "";

        // Clear board
        svg.innerHTML = '';
        svg.appendChild(boardImage);

        // Reset to first player
        currentPlayer = 0;
        updateTurnDisplay();

        // Fade out win screen, fade in game screen
        document.getElementById("winScreen").style.opacity = "0";
        setTimeout(() => {
            document.getElementById("winScreen").style.display = "none";
            document.getElementById("gameScreen").style.display = "block";
            document.getElementById("gameScreen").style.opacity = "0";
            document.getElementById("scoreboard").style.display = "block";
            document.getElementById("turnDisplay").style.display = "block";
            document.getElementById("undoButton").style.display = "block";
            document.getElementById("mainMenuButton").style.display = "block";
            setTimeout(() => document.getElementById("gameScreen").style.opacity = "1", 10);
        }, 500);
    }

    function quitGameplay() {
        document.getElementById("gameScreen").style.opacity = "0";
        setTimeout(() => {
            document.getElementById("gameScreen").style.display = "none";
            document.getElementById("turnDisplay").style.display = "none";
            document.getElementById("undoButton").style.display = "none";
            document.getElementById("quitGameplayButton").style.display = "none";
            document.getElementById("mainMenuButton").style.display = "none";
            
            gameOver = false;
            placedStones.clear();
            captures = { blue: 0, red: 0, yellow: 0, green: 0 };
            moveHistory = [];
            updateScoreboard();
            
            document.getElementById("blueCapturedStones").innerHTML = "";
            document.getElementById("redCapturedStones").innerHTML = "";
            document.getElementById("yellowCapturedStones").innerHTML = "";
            document.getElementById("greenCapturedStones").innerHTML = "";
            
            svg.innerHTML = '';
            svg.appendChild(boardImage);
            
            document.getElementById("nameEntryScreen").style.display = "block";
            document.getElementById("nameEntryScreen").style.opacity = "1";
            document.getElementById("scoreboard").style.display = "none";
        }, 500);
    }

    function quitToMainMenu() {
        document.getElementById("gameScreen").style.opacity = "0";
        setTimeout(() => {
            document.getElementById("gameScreen").style.display = "none";
            document.getElementById("turnDisplay").style.display = "none";
            document.getElementById("undoButton").style.display = "none";
            document.getElementById("mainMenuButton").style.display = "none";
            
            gameOver = false;
            placedStones.clear();
            captures = { blue: 0, red: 0, yellow: 0, green: 0 };
            moveHistory = [];
            scores = { blue: 0, red: 0, yellow: 0, green: 0 };
            updateScoreboard();
            
            document.getElementById("blueCapturedStones").innerHTML = "";
            document.getElementById("redCapturedStones").innerHTML = "";
            document.getElementById("yellowCapturedStones").innerHTML = "";
            document.getElementById("greenCapturedStones").innerHTML = "";
            
            svg.innerHTML = '';
            svg.appendChild(boardImage);
            
            document.getElementById("player1Name").value = "";
            document.getElementById("player2Name").value = "";
            document.getElementById("player3Name").value = "";
            document.getElementById("player4Name").value = "";
            
            document.getElementById("player1Entry").style.display = "none";
            document.getElementById("player2Entry").style.display = "none";
            document.getElementById("player3Entry").style.display = "none";
            document.getElementById("player4Entry").style.display = "none";
            document.getElementById("playButton").style.display = "none";
            document.getElementById("tournamentButton").style.display = "none";
            document.getElementById("backButton").style.display = "none";
            document.getElementById("play2Button").style.display = "inline-block";
            document.getElementById("play4Button").style.display = "inline-block";
            
            document.getElementById("nameEntryScreen").style.display = "block";
            document.getElementById("nameEntryScreen").style.opacity = "1";
            document.getElementById("scoreboard").style.display = "none";
        }, 500);
    }

    function quitGame() {
        gameOver = false;
        placedStones.clear();
        captures = { blue: 0, red: 0, yellow: 0, green: 0 };
        moveHistory = [];
        scores = { blue: 0, red: 0, yellow: 0, green: 0 };
        updateScoreboard();
        
        document.getElementById("blueCapturedStones").innerHTML = "";
        document.getElementById("redCapturedStones").innerHTML = "";
        document.getElementById("yellowCapturedStones").innerHTML = "";
        document.getElementById("greenCapturedStones").innerHTML = "";
        
        svg.innerHTML = '';
        svg.appendChild(boardImage);
        
        document.getElementById("player1Name").value = "";
        document.getElementById("player2Name").value = "";
        document.getElementById("player3Name").value = "";
        document.getElementById("player4Name").value = "";
        
        document.getElementById("winScreen").style.opacity = "0";
        setTimeout(() => {
            document.getElementById("gameScreen").style.display = "none";
            document.getElementById("winScreen").style.display = "none";
            document.getElementById("scoreboard").style.display = "none";
            
            // Reset player selection to initial state
            document.getElementById("player1Entry").style.display = "none";
            document.getElementById("player2Entry").style.display = "none";
            document.getElementById("player3Entry").style.display = "none";
            document.getElementById("player4Entry").style.display = "none";
            document.getElementById("playButton").style.display = "none";
            document.getElementById("tournamentButton").style.display = "none";
            document.getElementById("backButton").style.display = "none";
            document.getElementById("play2Button").style.display = "inline-block";
            document.getElementById("play4Button").style.display = "inline-block";
            
            document.getElementById("nameEntryScreen").style.display = "block";
            document.getElementById("nameEntryScreen").style.opacity = "1";
            document.getElementById("turnDisplay").style.display = "none";
            document.getElementById("undoButton").style.display = "none";
            document.getElementById("mainMenuButton").style.display = "none";
        }, 500);
    }

    function quitGameCompletely() {
        document.getElementById("nameEntryScreen").style.opacity = "0";
        setTimeout(() => window.close(), 500);
    }

    svg.addEventListener("click", (event) => {
        let rect = svg.getBoundingClientRect();
        let clickX = event.clientX - rect.left;
        let clickY = event.clientY - rect.top;

        let snappedX = Math.round((clickX - boardOffset) / spacing) * spacing + boardOffset;
        let snappedY = Math.round((clickY - boardOffset) / spacing) * spacing + boardOffset;

        placeStone(snappedX, snappedY);
    });

    /* New JavaScript additions for sound toggle */
    let isSoundOn = true;
function toggleSound() {
    isSoundOn = !isSoundOn;
    document.getElementById("soundToggleButton").style.backgroundImage = `url('${isSoundOn ? 'on.png' : 'off.png'}')`;
    placeSound.muted = !isSoundOn;
    captureSound.muted = !isSoundOn;
    winSound.muted = !isSoundOn;
}
</script>

</body>
</html>
